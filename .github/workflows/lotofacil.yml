name: Registrar Lotofacil

on:
  schedule:
    - cron: "0 22 * * 1-6"  # Segunda a s√°bado, 22h (UTC)
  workflow_dispatch:

jobs:
  atualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Instalar bibliotecas
        run: |
          pip install requests pandas

      - name: Coletar resultado da Lotofacil
        run: |
          python <<'EOF'
          import requests
          import pandas as pd
          from datetime import datetime

          # API oficial da Caixa (retorna JSON com √∫ltimo concurso)
          url = "https://servicebus2.caixa.gov.br/portaldeloterias/api/lotofacil/"

          try:
              print("üîç Consultando API da Caixa...")
              response = requests.get(url, timeout=15)
              response.raise_for_status()
              dados = response.json()

              # Extrair informa√ß√µes do concurso
              dezenas = dados.get("listaDezenas", [])
              data_sorteio = dados.get("dataApuracao", "")
              numero_concurso = dados.get("numero", "")

              print(f"üìä Concurso: {numero_concurso}")
              print(f"üìÖ Data: {data_sorteio}")
              print(f"üé≤ Dezenas: {dezenas}")

              if not dezenas or len(dezenas) != 15:
                  print("‚ö†Ô∏è Nenhuma dezena v√°lida encontrada na API")
                  exit(0)

              # Formatar dezenas como string separada por espa√ßo
              dezenas_str = " ".join(dezenas)

              # Usar data da API ou data atual
              if not data_sorteio:
                  data_sorteio = datetime.now().strftime("%d/%m/%Y")

              linha = {"Data": data_sorteio, "Dezenas": dezenas_str}

              # Ler CSV existente ou criar novo
              try:
                  df = pd.read_csv("lotofacil.csv")
                  print(f"üìÇ CSV existente encontrado com {len(df)} linhas")

                  # Evitar duplicatas: s√≥ adiciona se a data n√£o existir
                  if data_sorteio in df["Data"].values:
                      print(f"‚úÖ Sorteio de {data_sorteio} j√° registrado")
                      exit(0)
                  else:
                      df = pd.concat([df, pd.DataFrame([linha])], ignore_index=True)
                      print(f"‚ûï Nova linha adicionada")
              except FileNotFoundError:
                  print("üìÑ Criando novo CSV")
                  df = pd.DataFrame([linha])

              # Salvar CSV
              df.to_csv("lotofacil.csv", index=False)
              print(f"‚úÖ Registrado: {data_sorteio} ‚Üí {dezenas_str}")
              print(f"üìä Total de registros: {len(df)}")

          except requests.exceptions.RequestException as e:
              print(f"‚ùå Erro ao acessar API: {e}")
              exit(1)
          except Exception as e:
              print(f"‚ùå Erro inesperado: {e}")
              import traceback
              traceback.print_exc()
              exit(1)
          EOF

      - name: Commit
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add lotofacil.csv

          if git diff --cached --quiet; then
            echo "üì≠ Nada a commitar"
          else
            git commit -m "üìä Atualiza√ß√£o autom√°tica - $(date +'%d/%m/%Y %H:%M')"
            echo "‚úÖ Commit realizado"
          fi

      - name: Push
        run: |
          git push
          echo "üöÄ Push realizado com sucesso"

      - name: Enviar e-mail semanal (apenas s√°bados)
        if: github.event.schedule != '' && contains(github.event.schedule, '0 22 * * 6')
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.EMAIL_FROM }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üìä Resumo Semanal Lotofacil"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          body: |
            Ol√°, Gustavo!

            Segue o arquivo atualizado com todos os registros da semana.

            Abra o CSV anexo para ver o hist√≥rico completo.

            Abra√ßo,
            Sistema Autom√°tico
          attachments: lotofacil.csv
