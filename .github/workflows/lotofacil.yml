name: Registrar Lotof√°cil

on:
  schedule:
    - cron: "0 22 * * 1-6"  # Segunda a s√°bado, 22h
  workflow_dispatch:

jobs:
  atualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Instalar libs
        run: pip install requests bs4 pandas lxml

      - name: Coletar resultado da Lotof√°cil
        run: 
          python <<EOF
          import requests
          import pandas as pd
          from bs4 import BeautifulSoup
          from datetime import datetime

          url = "https://loterias.caixa.gov.br/Paginas/Lotofacil.aspx"
          html = requests.get(url).text
          soup = BeautifulSoup(html, "lxml")

          dezenas = [d.text.strip() for d in soup.select(".ng-binding.ng-scope")]

          # Filtrar apenas as √∫ltimas 15 dezenas
          dezenas_filtradas = [d for d in dezenas if d.isdigit()][:15]

          data = datetime.now().strftime("%d/%m/%Y")
          linha = {"Data": data, "Dezenas": " ".join(dezenas_filtradas)}

          try:
              df = pd.read_csv("lotofacil.csv")
              df = pd.concat([df, pd.DataFrame([linha])], ignore_index=True)
          except:
              df = pd.DataFrame([linha])

          df.to_csv("lotofacil.csv", index=False)
          print(f"‚úÖ Registrado: {data} ‚Üí {' '.join(dezenas_filtradas)}")
          EOF

      - name: Commit
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add loteria.csv
          git commit -m "üìä Atualiza√ß√£o autom√°tica - $(date +'%d/%m/%Y')" || echo "Nada a commitar"

      - name: Push
        run: git push

      - name: Enviar e-mail semanal (apenas s√°bados)
        if: github.event.schedule != '' && contains(github.event.schedule, '0 22 * * 6')
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.EMAIL_FROM }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üìä Resumo Semanal Lotof√°cil"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          body: |
            Ol√°, Gustavo!

            Segue o arquivo atualizado com todos os registros da semana.

            Abra o CSV anexo para ver o hist√≥rico completo.

            Abra√ßo,
            Sistema Autom√°tico
          attachments: lotofacil.csv
