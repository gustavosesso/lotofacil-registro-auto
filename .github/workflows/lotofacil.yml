name: Registrar Lotofacil

on:
  schedule:
    - cron: "0 22 * * 1-6"  # Segunda a s√°bado, 22h (UTC)
  workflow_dispatch:

jobs:
  atualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Instalar bibliotecas
        run: |
          pip install requests pandas

      - name: Coletar resultado da Lotofacil
        run: |
          python <<'EOF'
          import requests
          import pandas as pd
          from datetime import datetime

          # Tentar API oficial primeiro
          urls = [
              "https://servicebus2.caixa.gov.br/portaldeloterias/api/lotofacil/",
              "https://loteriascaixa.com.br/api/lotofacil/ultimo"
          ]

          dados = None
          for url in urls:
              try:
                  print(f"üîç Tentando: {url}")
                  response = requests.get(url, timeout=15)
                  response.raise_for_status()
                  dados = response.json()
                  print(f"‚úÖ Sucesso com: {url}")
                  break
              except Exception as e:
                  print(f"‚ö†Ô∏è Falhou: {e}")
                  continue

          if not dados:
              print("‚ùå Nenhuma API respondeu")
              exit(1)

          # Extrair dezenas (tentar diferentes formatos)
          dezenas = (
              dados.get("listaDezenas") or 
              dados.get("dezenas") or 
              dados.get("numeros") or
              []
          )

          # Extrair data
          data_sorteio = (
              dados.get("dataApuracao") or
              dados.get("data") or
              datetime.now().strftime("%d/%m/%Y")
          )

          print(f"üìÖ Data: {data_sorteio}")
          print(f"üé≤ Dezenas: {dezenas}")

          if not dezenas or len(dezenas) < 15:
              print("‚ö†Ô∏è Dezenas insuficientes")
              exit(0)

          # Garantir que s√£o strings com zero √† esquerda
          dezenas = [str(d).zfill(2) for d in dezenas[:15]]
          dezenas_str = " ".join(dezenas)

          linha = {"Data": data_sorteio, "Dezenas": dezenas_str}

          try:
              df = pd.read_csv("lotofacil.csv")
              if data_sorteio in df["Data"].values:
                  print(f"‚úÖ J√° registrado: {data_sorteio}")
                  exit(0)
              df = pd.concat([df, pd.DataFrame([linha])], ignore_index=True)
          except FileNotFoundError:
              df = pd.DataFrame([linha])

          df.to_csv("lotofacil.csv", index=False)
          print(f"‚úÖ Registrado: {data_sorteio} ‚Üí {dezenas_str}")
          EOF

      - name: Commit
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add lotofacil.csv

          if git diff --cached --quiet; then
            echo "üì≠ Nada a commitar"
          else
            git commit -m "üìä Atualiza√ß√£o autom√°tica - $(date +'%d/%m/%Y %H:%M')"
            echo "‚úÖ Commit realizado"
          fi

      - name: Push
        run: |
          git pull --rebase origin main || echo "Nada para puxar"
          git push
          echo "üöÄ Push realizado com sucesso"

      - name: Enviar e-mail semanal (apenas s√°bados)
        if: github.event.schedule != '' && contains(github.event.schedule, '0 22 * * 6')
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.EMAIL_FROM }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üìä Resumo Semanal Lotofacil"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          body: |
            Ol√°, Gustavo!

            Segue o arquivo atualizado com todos os registros da semana.

            Abra o CSV anexo para ver o hist√≥rico completo.

            Abra√ßo,
            Sistema Autom√°tico
          attachments: lotofacil.csv
